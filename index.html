<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>上課追蹤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 針對手機觸控優化 */
        .cell-absent { background-color: #fee2e2; color: #b91c1c; border: 2px solid #ef4444; }
        .cell-present { background-color: #dcfce7; color: #15803d; border: 2px solid #22c55e; }
        td { height: 80px; min-width: 80px; transition: all 0.2s; }
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="sticky top-0 z-10 bg-white shadow-md p-4">
        <h1 class="text-xl font-bold mb-3 text-center">出席率看板 (1/3 警告)</h1>
        <div id="statsDashboard" class="flex overflow-x-auto gap-3 pb-2">
            </div>
    </div>

    <div class="p-4">
        <div id="weekSelector" class="flex gap-2 overflow-x-auto mb-6 py-2 no-scrollbar">
            </div>

        <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
            <div class="bg-indigo-600 text-white p-3 text-center font-bold text-lg" id="currentWeekTitle">第 1 週</div>
            <div class="overflow-x-auto">
                <table class="w-full text-center border-collapse">
                    <thead>
                        <tr class="bg-gray-50 text-xs text-gray-500">
                            <th class="p-2 border-b w-12">時段</th>
                            <th class="p-2 border-b">一</th><th class="p-2 border-b">二</th>
                            <th class="p-2 border-b">三</th><th class="p-2 border-b">四</th>
                            <th class="p-2 border-b">五</th>
                        </tr>
                    </thead>
                    <tbody id="timetableBody" class="text-[13px]">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const timeSlots = ["08:10", "09:10", "10:10", "11:10", "13:00", "14:10", "15:10"];
        const rawSchedule = [
            ["補強數學[選]", "彈性學習時間", "選修物理-電磁現象二與量子現象[選]", "多元選修[選]", "體育[必]"],
            ["語文表達與傳播應用[選]", "彈性學習時間", "英文閱讀與寫作[選]", "多元選修[選]", "補強數學"],
            ["語文表達與傳播應用[選]", "選修化學-化學反應與平衡二[選]", "國學常識[選]", "英文閱讀與寫作[選]", "選修物理-波動、光及聲音"],
            ["英文聽講", "體育[必]", "選修化學-有機化學與應用科技[選]", "數學甲[選]", "專題閱讀與研究"],
            ["音樂[必]", "數學甲[選]", "藝術生活[必]", "自主學習時間", "閱讀與研究模組-科學閱讀與研究[必]"],
            ["選修物理-電磁現象二與量子現象[選]", "國學常識[選]", "數學甲[選]", "團體活動時間", "全民國防教育[必]"],
            ["選修化學-化學反應與平衡二[選]", "英文聽講[選]", "數學甲[選]", "團體活動時間", "補強英語"]
        ];

        let currentWeek = 1;
        let attendance = JSON.parse(localStorage.getItem('edu_attendance_mobile')) || {};

        function init() {
            renderWeekSelector();
            renderTable();
            renderStats();
        }

        function renderWeekSelector() {
            const container = document.getElementById('weekSelector');
            container.innerHTML = '';
            for(let i=1; i<=17; i++) {
                const btn = document.createElement('button');
                btn.className = `flex-none px-5 py-2 rounded-xl font-bold transition ${currentWeek === i ? 'bg-indigo-600 text-white shadow-lg scale-105' : 'bg-white text-gray-400 border'}`;
                btn.innerText = `W${i}`;
                btn.onclick = () => { currentWeek = i; init(); };
                container.appendChild(btn);
            }
        }

        function renderTable() {
            document.getElementById('currentWeekTitle').innerText = `第 ${currentWeek} 週`;
            const tbody = document.getElementById('timetableBody');
            tbody.innerHTML = '';

            timeSlots.forEach((time, rIdx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="text-[10px] text-gray-400 border-r bg-gray-50 font-medium">${time}</td>`;
                
                rawSchedule[rIdx].forEach((course, cIdx) => {
                    const key = `${currentWeek}-${rIdx}-${cIdx}`;
                    const status = attendance[key] || 'none';
                    const td = document.createElement('td');
                    td.className = `border-b border-r p-1 relative active:scale-95 transition-transform ${status === 'present' ? 'cell-present' : (status === 'absent' ? 'cell-absent' : 'text-gray-800')}`;
                    
                    const isRequired = course.includes("[必]");
                    const isElective = course.includes("[選]");
                    const displayName = course.replace("[必]", "").replace("[選]", "");

                    td.innerHTML = `
                        <div class="font-bold leading-tight mb-1">${displayName}</div>
                        <div class="text-[9px] opacity-70">${isRequired ? '必修' : (isElective ? '選修' : '')}</div>
                        <div class="absolute bottom-1 right-1 text-xs">${status === 'present' ? '✅' : (status === 'absent' ? '❌' : '')}</div>
                    `;
                    
                    td.onclick = () => {
                        const next = status === 'none' ? 'present' : (status === 'present' ? 'absent' : 'none');
                        if (next === 'none') delete attendance[key]; else attendance[key] = next;
                        localStorage.setItem('edu_attendance_mobile', JSON.stringify(attendance));
                        renderTable();
                        renderStats();
                    };
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function renderStats() {
            const statsContainer = document.getElementById('statsDashboard');
            statsContainer.innerHTML = '';
            const subjectStats = {};

            rawSchedule.forEach((row, rIdx) => {
                row.forEach((course) => {
                    if(!subjectStats[course]) subjectStats[course] = { total: 17, absent: 0 };
                });
            });

            Object.keys(attendance).forEach(key => {
                const [w, r, c] = key.split('-');
                if(attendance[key] === 'absent') subjectStats[rawSchedule[r][c]].absent++;
            });

            Object.entries(subjectStats).forEach(([name, data]) => {
                const percent = ((data.absent / data.total) * 100).toFixed(1);
                const isDanger = data.absent / data.total >= 0.333;
                const card = document.createElement('div');
                card.className = `flex-none w-32 p-3 rounded-2xl border-2 ${isDanger ? 'bg-red-50 border-red-500 animate-pulse' : 'bg-white border-indigo-100 shadow-sm'}`;
                card.innerHTML = `
                    <div class="text-[10px] font-bold text-gray-500 truncate">${name}</div>
                    <div class="text-lg font-black ${isDanger ? 'text-red-600' : 'text-indigo-600'}">${percent}%</div>
                    <div class="text-[9px] text-gray-400">缺 ${data.absent} 堂</div>
                `;
                statsContainer.appendChild(card);
            });
        }
        init();
    </script>
</body>
</html>